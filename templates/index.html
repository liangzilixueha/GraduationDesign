<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <title>å›¾ç‰‡ä¸Šä¼ </title>
    <link rel="stylesheet" href="/static/css/upload.css" />
    <link rel="stylesheet" href="/static/css/item.css" />
    <link rel="stylesheet" href="/static/css/button.css" />
    <link rel="stylesheet" href="/static/css/cut.css" />
    <script src="/static/js/button.js"></script>
    <script>
      var data = [];
      function previewImage(event) {
        const input = event.target;
        const preview = document.getElementById("preview");
        console.log(input.files[0].name);
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          const formData = new FormData();
          formData.append("file", input.files[0]);
          fetch("/uploadpdf", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.blob())
            .then((data) => {
              //è®¾ç½®å›¾ç‰‡çš„src
              const imageUrl = URL.createObjectURL(data);
              // è®¾ç½®å›¾ç‰‡çš„src
              preview.src = imageUrl;
              document.querySelector(".æç¤ºè¯").style.display = "none";
            });
        }
      }
      function è¯†åˆ«() {
        //å½“ä½ ä¸Šä¼ æ–‡ä»¶åï¼Œç‚¹å‡»ä¸Šä¼ ï¼Œä¼šè§¦å‘è¿™ä¸ªå‡½æ•°
        var filename = document.getElementById("fileInput").value;
        filename = filename.split("\\").pop();
        data.forEach((item) => {
          fetch("/ocr", {
            method: "POST",
            body: JSON.stringify({
              filename: filename,
              x: item[1],
              y: item[2],
              dx: item[3],
              dy: item[4],
            }),
          })
            .then((response) => response.text())
            .then((data) => {
              //åœ¨upload-containerä¸­æ‰¾åˆ°
              item[5] = data;
              åˆå§‹åŒ–();
            });
        });
      }
      function è¯†åˆ«ä½() {
        //å½“ä½ ä¸Šä¼ æ–‡ä»¶åï¼Œç‚¹å‡»ä¸Šä¼ ï¼Œä¼šè§¦å‘è¿™ä¸ªå‡½æ•°
        var filename = document.getElementById("fileInput").value;
        filename = filename.split("\\").pop();
        data.forEach((item) => {
          fetch("/ocr-low", {
            method: "POST",
            body: JSON.stringify({
              filename: filename,
              x: item[1],
              y: item[2],
              dx: item[3],
              dy: item[4],
            }),
          })
            .then((response) => response.text())
            .then((data) => {
              //åœ¨upload-containerä¸­æ‰¾åˆ°
              item[5] = data;
              åˆå§‹åŒ–();
            });
        });
      }
      function è·å–è£å‰ªç»“æœ(element) {
        //éå†dataï¼Œæ‰¾åˆ°å¯¹åº”çš„åæ ‡
        var x, y, dx, dy;
        data.forEach((item) => {
          if (item[0] == element) {
            x = item[1];
            y = item[2];
            dx = item[3];
            dy = item[4];
          }
        });
        const preview = document.getElementById("preview");
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const xx = preview.width * x;
        const yy = preview.height * y;
        const w = preview.width * dx;
        const h = preview.height * dy;
        canvas.width = w;
        canvas.height = h;
        ctx.drawImage(preview, xx, yy, w, h, 0, 0, w, h);
        //ä½¿ç”¨sweetAlertå±•ç¤ºè£å‰ªç»“æœ,imgè‡ªé€‚åº”å¤§å°
        swal({
          title: "è¯†åˆ«åŒºåŸŸ",
          content: {
            element: "img",
            attributes: {
              src: canvas.toDataURL(),
              style: "width:100%;height:auto",
            },
          },
        });
      }
      function ä¿®æ”¹åŒºåŸŸ(element) {
        // è·å–å›¾åƒé¢„è§ˆå’ŒåŒºåŸŸå…ƒç´ 
        var img = document.getElementById("preview");
        var cutImg = document.querySelector(".cut-img");

        // æ˜¾ç¤ºå›¾åƒé¢„è§ˆåŒºåŸŸ
        cutImg.style.display = "flex";
        // è®¾ç½®å›¾åƒé¢„è§ˆåŒºåŸŸçš„å›¾åƒä¸ºå½“å‰å›¾åƒ
        cutImg.querySelector("img").src = img.src;

        //ç‚¹å‡»é™¤äº†å›¾åƒå¤–çš„åœ°æ–¹ï¼Œéšè—å›¾åƒé¢„è§ˆåŒºåŸŸ
        cutImg.onclick = function (e) {
          if (e.target == cutImg) {
            cutImg.style.display = "none";
          }
        };

        //è®¾ç½®imgå·¦ä¸Šè§’ä¸º0,0,å³ä¸‹è§’ä¸º1,1,è·å–é¼ æ ‡æŒ‰ä¸‹æ—¶çš„ç™¾åˆ†æ¯”åæ ‡å’Œé¼ æ ‡æŠ¬èµ·æ—¶çš„ç™¾åˆ†æ¯”åæ ‡
        var x1, y1, x2, y2;
        cutImg.onmousedown = function (e) {
          x1 = e.offsetX / img.width;
          y1 = e.offsetY / img.height;
        };
        cutImg.onmouseup = function (e) {
          x2 = e.offsetX / img.width;
          y2 = e.offsetY / img.height;
          //å¦‚æœé¼ æ ‡æŠ¬èµ·æ—¶çš„åæ ‡å°äºæŒ‰ä¸‹æ—¶çš„åæ ‡ï¼Œäº¤æ¢ä¸¤è€…çš„å€¼
          if (x1 > x2) {
            [x1, x2] = [x2, x1];
          }
          if (y1 > y2) {
            [y1, y2] = [y2, y1];
          }
          if (x1 < 0 || x1 > 1 || x2 < 0 || x2 > 1) {
            return;
          }
          const preview = document.getElementById("preview");
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const xx = preview.width * x1;
          const yy = preview.height * y1;
          const w = preview.width * (x2 - x1);
          const h = preview.height * (y2 - y1);
          canvas.width = w;
          canvas.height = h;
          ctx.drawImage(preview, xx, yy, w, h, 0, 0, w, h);
          //ä½¿ç”¨sweetAlertå±•ç¤ºè£å‰ªç»“æœ,imgè‡ªé€‚åº”å¤§å°
          swal({
            title: "è£å‰ªåŒºåŸŸå¦‚ä¸‹",
            content: {
              element: "img",
              attributes: {
                src: canvas.toDataURL(),
                style: "width:100%;height:auto",
              },
            },
          });
          //éå†dataï¼Œä¿®æ”¹å¯¹åº”çš„åæ ‡
          data.forEach((item) => {
            if (item[0] == element) {
              item[1] = x1;
              item[2] = y1;
              item[3] = x2 - x1;
              item[4] = y2 - y1;
            }
          });
        };
      }
      function åˆå§‹åŒ–() {
        //æ‰¾åˆ°info-container
        const infoContainer = document.querySelector(".info-container");
        infoContainer.innerHTML = "";
        var item = data.forEach((item) => {
          infoContainer.innerHTML += `<div class="info-item">
            <div class="info-title">${item[0]}</div>
            <div class="info-content">
              <input type="text" id="type" value="${item[5]}" onchange="ä¿®æ”¹è¯†åˆ«å†…å®¹(event,'${item[0]}')"/>
            </div>
            <div class="è¯†åˆ«åŒºåŸŸ" onclick="è·å–è£å‰ªç»“æœ('${item[0]}')">ğŸ‘€</div>
            <div class="ä¿®æ”¹è¯†åˆ«åŒºåŸŸ" onclick="ä¿®æ”¹åŒºåŸŸ('${item[0]}')">âœ</div>
            <div class="åˆ é™¤" onclick="åˆ é™¤('${item[0]}')">ğŸ”¥</div>
          </div> `;
        });
      }
      function ä¿®æ”¹è¯†åˆ«å†…å®¹(event,id) {
        //éå†dataï¼Œæ‰¾åˆ°å¯¹åº”çš„å…ƒç´ ï¼Œä¿®æ”¹
        data.forEach((item) => {
          if (item[0] == id) {
            item[5] = event.target.value;
          }
        });
      }
      function åŠ ä¸€æ¡() {
        //swltå¼¹çª—ï¼Œè¾“å…¥æ¡†ï¼Œè¯¢é—®ç”¨æˆ·è¦æ·»åŠ çš„æ¡ç›®åç§°
        swal("è¯·è¾“å…¥è¦æ·»åŠ çš„æ¡ç›®åç§°:", {
          content: "input",
        }).then((value) => {
          //å¦‚æœç”¨æˆ·è¾“å…¥äº†å†…å®¹ï¼Œå°†å†…å®¹æ·»åŠ åˆ°dataä¸­
          if (value) {
            data.push([value, 0, 0, 0.5, 0.5, "æœªè¯†åˆ«"]);
            åˆå§‹åŒ–();
          }
        });
      }
      function åˆ é™¤(element) {
        //éå†dataï¼Œæ‰¾åˆ°å¯¹åº”çš„å…ƒç´ ï¼Œåˆ é™¤
        data.forEach((item, index) => {
          if (item[0] == element) {
            data.splice(index, 1);
          }
        });
        åˆå§‹åŒ–();
      }
      function ä¿å­˜è‡³æ•°æ®åº“() {
        var filename = document.getElementById("fileInput").value.split("\\").pop();
        //æç¤ºæ˜¯å¦ä¿å­˜è‡³æ•°æ®åº“
        swal({
          title: "æ˜¯å¦ä¿å­˜"+filename+"è‡³æ•°æ®åº“?",
          icon: "warning",
          buttons: {
            cancel: "å–æ¶ˆ",
            confirm: "ç¡®å®š",
          },
        })
        .then((message) => {
          if(message){
            fetch("/save", {
              method: "POST",
              body: JSON.stringify({
                filename: filename,
                data: data,
              }),
            })
          }
        });
      }
      function ä¿å­˜é…ç½®() {
        //å°†dataè½¬æ¢ä¸ºjson
        var dataJson = {};
        data.forEach((item) => {
          dataJson[item[0]] = item.slice(1, 5);
        });
        //ä¸‹è½½ä¸ºdata.json
        var a = document.createElement("a");
        var blob = new Blob([JSON.stringify(dataJson)], { type: "text/plain" });
        a.href = URL.createObjectURL(blob);
        a.download = "data.json";
        a.click();
      }
      function åŠ è½½é…ç½®(){
        //è®©ç”¨æˆ·åœ¨æœ¬åœ°é€‰æ‹©ä¸€ä¸ªjsonæ–‡ä»¶
        var input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = function (e) {
          var file = e.target.files[0];
          var reader = new FileReader();
          reader.onload = function (e) {
            var dataJson = JSON.parse(e.target.result);
            data = [];
            for (var key in dataJson) {
              data.push([key].concat(dataJson[key], "æœªè¯†åˆ«"));
            }
            åˆå§‹åŒ–();
          };
          reader.readAsText(file);
        };
        input.click();
      }
      document.addEventListener("DOMContentLoaded", åˆå§‹åŒ–);
    </script>
  </head>
  <body>
    <div class="cut-img">
      <img src="" alt="" draggable="false" />
    </div>
    <div class="main">
      <div class="upload-container">
        <input
          type="file"
          id="fileInput"
          accept=".pdf,.png"
          onchange="previewImage(event)"
        />
        <h1 class="æç¤ºè¯">ç‚¹å‡»ä¸Šä¼ ï¼Œå½“å‰ä»…æ”¯æŒpdf</h1>
        <img id="preview" class="upload-preview" src="" alt="" />
      </div>
      <div class="add-item" onclick="åŠ ä¸€æ¡()">
        <h2>åŠ ä¸€æ¡</h2>
      </div>
      <div class="config">
        <div style="margin-right: 10px;" onclick="ä¿å­˜é…ç½®()">ä¿å­˜å‚æ•°é…ç½®</div>
        <div style="margin-left: 10px;" onclick="åŠ è½½é…ç½®()">åŠ è½½å‚æ•°é…ç½®</div>
      </div>
      <div class="info-container">
        <!-- æ­¤å¤„å°†ç”±jsæ·»åŠ æ¡ç›® -->
      </div>
    </div>
    <div class="æŒ‰é’®">
      <button class="upload-info" onclick="ä¿å­˜è‡³æ•°æ®åº“()">ä¿å­˜è‡³æ•°æ®åº“</button>
      <button class="upload-img" onclick="è¯†åˆ«()">è¯†åˆ«</button>
      <button class="upload-img-low" onclick="è¯†åˆ«ä½()">è¯†åˆ«ä½</button>
      <button class="check-true" onclick="æŸ¥éªŒçœŸä¼ª()">æŸ¥éªŒçœŸä¼ª</button>
    </div>
  </body>
</html>
